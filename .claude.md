# Sonic Music - Claude é¡¹ç›®æŒ‡å—

> ç‰ˆæœ¬ï¼šv0.0.3-dev | åˆ†æ”¯ï¼šv0.0.3-dev
> æŠ€æœ¯æ ˆï¼šVue3 `<script setup>` + çº¯ JavaScript + åŸç”Ÿ CSS + UniApp

---

## é¡¹ç›®æ¦‚è¿°

Sonic Music æ˜¯ä¸€ä¸ªåŸºäºé…·ç‹— API çš„éŸ³ä¹æ’­æ”¾å™¨ï¼Œé‡‡ç”¨ monorepo ç»“æ„ï¼ŒåŒ…å«æ¡Œé¢ç«¯ï¼ˆElectronï¼‰å’Œç§»åŠ¨ç«¯ï¼ˆUniAppï¼‰ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œå…±äº«åŒä¸€å¥—åç«¯ API å’Œå…¬å…±é€»è¾‘åŒ…ã€‚

```
sonic-music/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/              # Express + Kugou APIï¼ˆ150+ æ¥å£ï¼‰ç«¯å£ 6521
â”‚   â”œâ”€â”€ electron/         # Vue3 + Vite 7 + Pinia + Electron âœ… v0.0.2 å·²å®Œæˆ
â”‚   â””â”€â”€ mobile/           # UniApp Vue3 H5/iOS/Android ğŸ”„ v0.0.3 å¼€å‘ä¸­
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/           # å…±äº« JS é€»è¾‘ï¼ˆutils/stores/composablesï¼‰
â”œâ”€â”€ docs/architecture/    # æ¶æ„æ–‡æ¡£
â”œâ”€â”€ pnpm-workspace.yaml
â””â”€â”€ package.json
```

### apps/mobile ç›®å½•ç»“æ„

```
apps/mobile/
â”œâ”€â”€ index.html            # Vite å…¥å£ï¼ˆå¿…é¡»åœ¨æ ¹ç›®å½•ï¼Œå« <script type="module" src="/src/main.js">ï¼‰
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ package.json
â””â”€â”€ src/
    â”œâ”€â”€ App.vue           # æ ¹ç»„ä»¶ï¼šä¸»é¢˜åˆå§‹åŒ– + MiniPlayer æŒ‚è½½
    â”œâ”€â”€ main.js           # å…¥å£ï¼šæ³¨å†Œ pinia
    â”œâ”€â”€ manifest.json     # UniApp åº”ç”¨é…ç½®
    â”œâ”€â”€ pages.json        # è·¯ç”± + Tab Bar é…ç½®
    â”œâ”€â”€ uni.scss          # å…¨å±€è®¾è®¡ Tokenï¼ˆCSS å˜é‡ï¼‰
    â”œâ”€â”€ api/
    â”‚   â”œâ”€â”€ client.js     # uni.request å°è£…ï¼ˆget/postï¼‰
    â”‚   â”œâ”€â”€ song.js       # æ­Œæ›²ç›¸å…³ API
    â”‚   â”œâ”€â”€ playlist.js   # æ­Œå• API
    â”‚   â”œâ”€â”€ search.js     # æœç´¢ API
    â”‚   â”œâ”€â”€ ranking.js    # æ’è¡Œæ¦œ API
    â”‚   â””â”€â”€ user.js       # ç”¨æˆ·/ç™»å½• API
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ player/       # MiniPlayer.vueã€PlayerControls.vueã€ProgressSlider.vue
    â”‚   â””â”€â”€ common/       # SongListItem.vueã€PlaylistCard.vueã€NavBar.vue
    â”œâ”€â”€ composables/
    â”‚   â”œâ”€â”€ useAudioPlayer.js  # éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒï¼ˆloadAndPlayã€pauseã€seekï¼‰
    â”‚   â””â”€â”€ useLyrics.js       # æ­Œè¯æ»šåŠ¨é€»è¾‘
    â”œâ”€â”€ pages/
    â”‚   â”œâ”€â”€ home/index.vue         âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ search/index.vue       âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ search/result.vue      âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ discover/index.vue     âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ library/index.vue      âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ settings/index.vue     âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ player/index.vue       âœ… å·²å®Œæˆ
    â”‚   â”œâ”€â”€ playlist/detail.vue    â¬œ å¾…å¼€å‘
    â”‚   â”œâ”€â”€ ranking/index.vue      â¬œ å¾…å¼€å‘
    â”‚   â”œâ”€â”€ login/index.vue        â¬œ å¾…å¼€å‘
    â”‚   â””â”€â”€ artist/detail.vue      â¬œ å¾…å¼€å‘
    â”œâ”€â”€ stores/
    â”‚   â””â”€â”€ player.js     # mobile ä¸“ç”¨æ’­æ”¾å™¨çŠ¶æ€
    â””â”€â”€ utils/
        â”œâ”€â”€ storage.js    # uni.getStorageSync å°è£…
        â””â”€â”€ theme.js      # applyTheme(theme) åº”ç”¨ä¸»é¢˜
```

---

## å¼€å‘å‘½ä»¤

```bash
pnpm dev:mobile     # å¯åŠ¨ H5 å¼€å‘æœåŠ¡å™¨ â†’ http://localhost:5174/
pnpm dev:api        # å¯åŠ¨ API æœåŠ¡ â†’ http://127.0.0.1:6521
pnpm dev:electron   # å¯åŠ¨ Electron
```

---

## æŠ€æœ¯æ ˆçº¦å®š

### âœ… å¿…é¡»ä½¿ç”¨
- Vue 3 `<script setup>` + çº¯ JavaScriptï¼ˆä¸ç”¨ TypeScriptï¼‰
- åŸç”Ÿ CSS scoped + CSS å˜é‡ï¼ˆä¸ç”¨ SCSS/LESS/UnoCSS/Tailwindï¼‰
- Piniaï¼ˆä¸ç”¨ storeToRefsï¼Œç›´æ¥è®¿é—® store å±æ€§ï¼‰
- UniApp APIï¼ˆ`uni.request`ã€`uni.navigateTo`ã€`uni.getStorageSync` ç­‰ï¼‰
- rpx å•ä½ï¼ˆ750rpx = å±å¹•å®½åº¦ï¼‰

### âŒ ç¦æ­¢ä½¿ç”¨
- TypeScriptï¼ˆ.ts æ–‡ä»¶ã€ç±»å‹æ³¨è§£ã€interfaceã€enumï¼‰
- axiosï¼ˆç”¨ `uni.request` å°è£…çš„ `api/client.js`ï¼‰
- localStorageï¼ˆç”¨ `uni.getStorageSync`ï¼‰
- HTML æ ‡ç­¾ï¼ˆdiv/span/img/p â†’ å¿…é¡»ç”¨ view/text/imageï¼‰
- document/windowï¼ˆH5 ä»¥å¤–ä¸å¯ç”¨ï¼‰
- storeToRefs
- uView UIï¼ˆå·²ç§»é™¤ï¼Œç”¨åŸç”Ÿ CSS å®ç°ï¼‰

---

## packages/shared å†…å®¹æ¸…å•

### å½“å‰å·²æœ‰

```
packages/shared/src/
â”œâ”€â”€ constants/index.js         # QUALITY_MAPã€THEME_COLORSã€DEFAULT_API_URL
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ cover.js               # getCover(url, size) â†’ å°é¢å›¾ URL
â”‚   â”œâ”€â”€ time.js                # formatMilliseconds(ms)ã€formatSeconds(s)
â”‚   â”œâ”€â”€ lyrics.js              # parseLyrics(lrc)ã€getCurrentLineIndex(lyrics, time)
â”‚   â”œâ”€â”€ quality.js             # getQuality(song, quality) â†’ éŸ³è´¨ hash
â”‚   â””â”€â”€ format.js              # formatPlayCount(count) â†’ "1.2ä¸‡"/"3.4äº¿"
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ auth.js                # MoeAuthStoreï¼ˆç™»å½•æ€ã€ç”¨æˆ·ä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ musicQueue.js          # useMusicQueueStoreï¼ˆæ’­æ”¾é˜Ÿåˆ—ï¼‰
â”‚   â””â”€â”€ settings.js            # useSettingsStoreï¼ˆapiBaseUrlã€qualityã€themeï¼‰
â””â”€â”€ composables/
    â”œâ”€â”€ usePlaybackMode.js     # æ’­æ”¾æ¨¡å¼åˆ‡æ¢ï¼ˆé¡ºåº/éšæœº/å•æ›²å¾ªç¯ï¼‰
    â””â”€â”€ useQueue.js            # é˜Ÿåˆ—æ“ä½œï¼ˆä¸Šä¸€é¦–/ä¸‹ä¸€é¦–/æ’å…¥ï¼‰
```

### å¯¼å…¥æ–¹å¼

```javascript
import { getCover } from '@sonic-music/shared/utils/cover'
import { formatMilliseconds } from '@sonic-music/shared/utils/time'
import { formatPlayCount } from '@sonic-music/shared/utils/format'
import { useSettingsStore } from '@sonic-music/shared/stores/settings'
import { MoeAuthStore } from '@sonic-music/shared/stores/auth'
import { THEME_COLORS } from '@sonic-music/shared/constants'
```

### å¾…æå–åˆ° sharedï¼ˆä¸‹ä¸€æ­¥ï¼‰

| åŠŸèƒ½ | å½“å‰ä½ç½® | ç›®æ ‡ |
|------|----------|------|
| æ’­æ”¾å™¨çŠ¶æ€é€»è¾‘ | mobile/stores/player.js | shared/stores/player.js |
| æœç´¢å†å² | mobile æœ¬åœ° | shared/stores/searchHistory.js |

---

## æ¨¡å—å¼€å‘é¡ºåºï¼ˆå½“å‰çŠ¶æ€ï¼‰

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| 0. packages/shared åŸºç¡€ | âœ… å®Œæˆ | utils/stores/composables |
| 1. mobile è„šæ‰‹æ¶ + API å±‚ | âœ… å®Œæˆ | client.js + å„ API æ¨¡å— |
| 2. æ’­æ”¾å™¨æ ¸å¿ƒ | âœ… å®Œæˆ | stores/player + useAudioPlayer + MiniPlayer |
| 3. ä¸»è¦é¡µé¢ | âœ… å®Œæˆ | home/search/discover/library/settings/player |
| 4. æ­Œå•è¯¦æƒ…é¡µ | âœ… å®Œæˆ | playlist/detail.vue |
| 5. æ’è¡Œæ¦œé¡µ | â¬œ å¾…å¼€å‘ | ranking/index.vue |
| 6. ç™»å½•é¡µ | â¬œ å¾…å¼€å‘ | login/index.vue |
| 7. æ­Œæ‰‹è¯¦æƒ…é¡µ | â¬œ å¾…å¼€å‘ | artist/detail.vue |
| 8. ä¸‹è½½åŠŸèƒ½ | â¬œ å¾…å¼€å‘ | stores/download + ä¸‹è½½ç®¡ç†é¡µ |

### å¼€å‘èŠ‚å¥è§„åˆ™
**ä¸€æ¬¡ä¸€ä¸ªæ¨¡å—ï¼Œå®Œæˆå commit å†ç»§ç»­ã€‚**

---

## UI å¯¹é½æµç¨‹ï¼ˆPlaywright æˆªå›¾å‚è€ƒï¼‰

æ¯ä¸ªæ–°æ¨¡å—å¼€å‘å‰ï¼Œå…ˆæˆªå›¾ Electron å¯¹åº”é¡µé¢ä½œä¸ºè®¾è®¡å‚è€ƒï¼š

```bash
# 1. å¯åŠ¨ H5 dev server
pnpm dev:mobile   # â†’ http://localhost:5174/

# 2. ç”¨ Playwright æˆªå›¾ï¼ˆåœ¨ Claude ä¸­è°ƒç”¨ MCPï¼‰
# æˆªå›¾ Electron å¯¹åº”é¡µé¢ â†’ åˆ†æè®¾è®¡è¯­è¨€ â†’ å®ç° Mobile ç‰ˆæœ¬
```

æˆªå›¾ä¼˜å…ˆçº§ï¼š
1. PlayerControl â†’ MiniPlayer + å…¨å±æ’­æ”¾å™¨
2. PlaylistDetail â†’ æ­Œå•è¯¦æƒ…é¡µ
3. Home â†’ é¦–é¡µ
4. Search â†’ æœç´¢é¡µ
5. Library â†’ æˆ‘çš„é¡µé¢

---

## CSS å˜é‡å®Œæ•´åˆ—è¡¨

```css
/* ä¸»é¢˜è‰²ï¼ˆç”± applyTheme() åŠ¨æ€è®¾ç½®ï¼‰ */
--primary-color              /* ä¸»è‰²ï¼Œå¦‚ #FF69B4 */
--secondary-color            /* è¾…è‰² */
--background-color           /* ä¸»èƒŒæ™¯ï¼Œå¦‚ #FFF0F5 */
--background-color-secondary /* æ¬¡èƒŒæ™¯ */
--color-primary              /* æ·±ä¸»è‰² */
--color-primary-light        /* ä¸»è‰²é€æ˜ç‰ˆ */
--border-color               /* è¾¹æ¡†è‰² */
--hover-color                /* æ‚¬åœè‰² */
--color-box-shadow           /* é˜´å½±è‰² */
--text-primary               /* ä¸»æ–‡å­—è‰²ï¼Œå¦‚ #333 */
--text-secondary             /* æ¬¡æ–‡å­—è‰²ï¼Œå¦‚ #999 */
```

### 4 å¥—ä¸»é¢˜

| ä¸»é¢˜ | Primary | Background |
|------|---------|------------|
| pinkï¼ˆé»˜è®¤ï¼‰ | #FF69B4 | #FFF0F5 |
| dark | #BB86FC | #121212 |
| blue | #4A90E2 | #E8F4FA |
| green | #34C759 | #E5F9F0 |

---

## API è°ƒç”¨è§„èŒƒ

```javascript
// api/client.js å°è£…äº† uni.requestï¼Œç»Ÿä¸€é€šè¿‡å®ƒè°ƒç”¨
import { get, post } from '@/api/client'

// API æ¨¡å—å®šä¹‰
export const getRecommend = () => get('/everyday/recommend')
export const getSongUrl = (hash, quality) => get('/song/url', { hash, quality })

// ç»„ä»¶ä¸­è°ƒç”¨
const res = await getRecommend()
songs.value = res.data?.song_list || res.list || []
```

---

## è·¯ç”±å¯¼èˆªè§„èŒƒ

```javascript
uni.navigateTo({ url: '/pages/playlist/detail?id=123' })  // æ™®é€šé¡µé¢ï¼ˆæœ‰è¿”å›æŒ‰é’®ï¼‰
uni.switchTab({ url: '/pages/home/index' })               // Tab é¡µé¢ï¼ˆå¿…é¡»ç”¨ switchTabï¼‰
uni.navigateBack()                                         // è¿”å›ä¸Šä¸€é¡µ
uni.reLaunch({ url: '/pages/home/index' })                // é‡å¯åˆ°æŒ‡å®šé¡µ
```

---

## Pinia Store è§„èŒƒ

```javascript
// å®šä¹‰
export const usePlayerStore = defineStore('player', {
  state: () => ({ currentSong: null, playing: false }),
  actions: {
    setCurrentSong(song) { this.currentSong = song }
  },
})

// ä½¿ç”¨ï¼ˆä¸ç”¨ storeToRefsï¼‰
const playerStore = usePlayerStore()
playerStore.setCurrentSong(song)
console.log(playerStore.currentSong)
```

æŒä¹…åŒ–ç”¨ `uni.getStorageSync`ï¼š
```javascript
persist: {
  strategies: [{
    storage: {
      getItem: (key) => uni.getStorageSync(key),
      setItem: (key, val) => uni.setStorageSync(key, val),
      removeItem: (key) => uni.removeStorageSync(key),
    }
  }]
}
```

---

## SFC ä»£ç è§„èŒƒ

### ç»“æ„é¡ºåºï¼štemplate â†’ script â†’ style

```vue
<template>
  <view class="page">...</view>
</template>

<script setup>
// 1. Vue æ ¸å¿ƒ
import { ref, computed } from 'vue'
// 2. UniApp ç”Ÿå‘½å‘¨æœŸ
import { onLoad, onShow } from '@dcloudio/uni-app'
// 3. Stores
import { usePlayerStore } from '@/stores/player'
// 4. æœ¬åœ°ç»„ä»¶
import SongListItem from '@/components/common/SongListItem.vue'
// 5. API å‡½æ•°
import { getRecommend } from '@/api/song'
// 6. å·¥å…·å‡½æ•°ï¼ˆsharedï¼‰
import { getCover } from '@sonic-music/shared/utils/cover'
</script>

<style scoped>
/* rpx å•ä½ï¼Œé¢œè‰²å¿…é¡»ç”¨ CSS å˜é‡ */
.page {
  padding: 30rpx;
  background: var(--background-color, #FFF0F5);
  min-height: 100vh;
}
</style>
```

---

## å¸ƒå±€å‚è€ƒ

```
Electronï¼ˆä¾§è¾¹æ ï¼‰              Mobileï¼ˆåº•éƒ¨å¯¼èˆªï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidebar  â”‚  Content â”‚  â†’    â”‚     Content      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     PlayerControl    â”‚       â”‚   MiniPlayer     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                               â”‚    Tab Bar       â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

MiniPlayer å®šä½ï¼ˆå›ºå®šåœ¨ Tab Bar ä¸Šæ–¹ï¼‰ï¼š
```css
.mini-player {
  position: fixed;
  bottom: calc(100rpx + env(safe-area-inset-bottom));
  left: 0; right: 0;
  z-index: 999;
}
```

---

## å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Vite 7 ä¸ @dcloudio/uni-h5-vite å…¼å®¹é—®é¢˜

**é—®é¢˜**ï¼šelectron ä½¿ç”¨ Vite 7ï¼ˆESM-onlyï¼‰ï¼Œuni-h5-vite ç”¨ `require('vite')` è§£æåˆ° Vite 7 å¯¼è‡´ `ERR_REQUIRE_ESM`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. `package.json` ä¸­æ·»åŠ  `pnpm.packageExtensions` å£°æ˜ dcloudio åŒ…çš„ vite peer dep
2. `.npmrc` ä¸­ `hoist-pattern[]=!vite` é˜»æ­¢ vite æå‡
3. åœ¨ `node_modules/.pnpm/@dcloudio+uni-h5-vite.../node_modules/` åˆ›å»ºæŒ‡å‘ Vite 5 çš„ junction

**æ³¨æ„**ï¼šjunction åœ¨ `pnpm install` åä¼šè¢«æ¸…é™¤ï¼Œéœ€é‡æ–°åˆ›å»ºï¼š
```powershell
New-Item -ItemType Junction -Path 'node_modules/.pnpm/@dcloudio+uni-h5-vite@.../node_modules/vite' -Target 'node_modules/.pnpm/vite@5.4.19_terser@5.46.0/node_modules/vite'
```

### index.html å¿…é¡»åœ¨ apps/mobile/ æ ¹ç›®å½•

vite çš„ root æ˜¯ `apps/mobile/`ï¼Œ`index.html` å¿…é¡»æ”¾åœ¨è¿™é‡Œï¼ˆä¸æ˜¯ `src/`ï¼‰ï¼Œä¸”å¿…é¡»åŒ…å«ï¼š
```html
<script type="module" src="/src/main.js"></script>
```

### UniApp æ¡ä»¶ç¼–è¯‘

```javascript
// #ifdef APP-PLUS || MP-WEIXIN
const bgAudio = uni.getBackgroundAudioManager()
// #endif

// #ifdef H5
const innerAudio = uni.createInnerAudioContext()
// #endif
```
