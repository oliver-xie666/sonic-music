# Sonic Music - Claude 项目指南

> 版本：v0.0.3-dev | 技术栈：Vue3 `<script setup>` + 纯 JavaScript + 原生 CSS + UniApp

---

## 项目结构

```
sonic-music/
├── apps/
│   ├── api/              # Express + Kugou API（150+ 接口）
│   ├── electron/         # Vue3 + Vite + Pinia + Electron（已完成 v0.0.2）
│   └── mobile/           # UniApp Vue3（开发中 v0.0.3）
├── packages/
│   └── shared/           # 共享工具函数 + Pinia stores
├── docs/architecture/    # 架构文档
├── pnpm-workspace.yaml
└── package.json
```

### apps/mobile 目录结构

```
apps/mobile/
├── index.html            # Vite 入口（含 <script type="module" src="/src/main.js">）
├── vite.config.js
├── package.json
└── src/
    ├── App.vue           # 根组件：主题初始化 + MiniPlayer 挂载
    ├── main.js           # 入口：注册 pinia
    ├── manifest.json     # UniApp 应用配置
    ├── pages.json        # 路由 + Tab Bar
    ├── uni.scss          # 全局设计 Token
    ├── api/              # HTTP 客户端 + 各业务 API 模块
    ├── components/
    │   ├── player/       # MiniPlayer、PlayerControls、ProgressSlider 等
    │   └── common/       # SongListItem、PlaylistCard、NavBar 等
    ├── composables/      # useAudioPlayer、useLyrics、useSearch 等
    ├── pages/            # home/discover/search/library/player/settings 等
    ├── stores/           # player.js、ui.js（mobile 专用）
    ├── static/icons/     # tabBar 图标（8 张：4 Tab × active/inactive）
    └── utils/            # storage.js、theme.js
```

---

## 开发命令

```bash
pnpm dev:mobile     # 启动 H5 开发服务器 → http://localhost:5174/
pnpm dev:api        # 启动 API 服务 → http://127.0.0.1:6521
pnpm dev:electron   # 启动 Electron
```

---

## 技术栈约定

### ✅ 使用
- Vue 3 `<script setup>` + 纯 JavaScript（不用 TypeScript）
- 原生 CSS scoped + CSS 变量（不用 SCSS/LESS/UnoCSS/Tailwind）
- Pinia（不用 storeToRefs，直接访问 store 属性）
- UniApp API（`uni.request`、`uni.navigateTo` 等）
- uView UI 2.x

### ❌ 禁止
- TypeScript（.ts 文件、类型注解、interface、enum）
- axios（用 `uni.request` 封装的 `api/client.js`）
- localStorage（用 `uni.getStorageSync`）
- HTML 标签（div/span/img/p → 用 view/text/image）
- document/window（H5 以外不可用）
- storeToRefs

---

## 代码规范

### SFC 结构顺序：template → script → style

```vue
<template>
  <view class="page">...</view>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { onLoad } from '@dcloudio/uni-app'
// ...
</script>

<style scoped>
/* rpx 单位，CSS 变量主题色 */
</style>
```

### Script 导入顺序

```javascript
// 1. Vue 核心
import { ref, computed, onMounted } from 'vue'
// 2. UniApp 生命周期
import { onLoad, onShow, onPullDownRefresh } from '@dcloudio/uni-app'
// 3. Stores
import { usePlayerStore } from '@/stores/player'
// 4. 本地组件
import SongListItem from '@/components/common/SongListItem.vue'
// 5. API 函数
import { getRecommend } from '@/api/song'
// 6. 工具函数
import { getCoverUrl } from '@sonic-music/shared/utils/cover'
```

### CSS 规范

```css
/* 布局用 rpx（750rpx = 屏幕宽度） */
/* 颜色必须用 CSS 变量 */
.item {
  padding: 24rpx 32rpx;
  background: var(--background-color);
  color: var(--primary-color);
}
```

### CSS 变量速查

```
--primary-color              主色
--secondary-color            辅色
--background-color           主背景
--background-color-secondary 次背景
--color-primary              深主色
--color-primary-light        主色透明
--border-color               边框
--hover-color                悬停
--color-box-shadow           阴影
```

### 4 套主题色

| 主题 | Primary | Background |
|---|---|---|
| Pink（默认） | #FF69B4 | #FFF0F5 |
| Blue | #4A90E2 | #E8F4FA |
| Green | #34C759 | #E5F9F0 |
| Orange | #ff6b6b | #FFF0F5 |

---

## 路由导航规范

```javascript
uni.navigateTo({ url: '/pages/playlist/detail?id=123' })  // 普通页面
uni.switchTab({ url: '/pages/home/index' })               // Tab 页面（必须用 switchTab）
uni.navigateBack()                                         // 返回
```

## UniApp 条件编译

```javascript
// #ifdef APP-PLUS || MP-WEIXIN
const bgAudio = uni.getBackgroundAudioManager()
// #endif

// #ifdef H5
const innerAudio = uni.createInnerAudioContext()
// #endif
```

---

## packages/shared 说明

```
packages/shared/src/
├── constants/index.js    # QUALITY_MAP、THEME_COLORS、DEFAULT_API_URL
├── utils/
│   ├── cover.js          # getCoverUrl(url, size)
│   ├── time.js           # formatMilliseconds()、formatSeconds()
│   ├── lyrics.js         # parseLyrics()、getCurrentLineIndex()
│   └── quality.js        # getQualityHash(song, quality)
└── stores/
    ├── auth.js            # MoeAuthStore
    ├── musicQueue.js      # useMusicQueueStore
    └── settings.js        # useSettingsStore（含 apiBaseUrl、quality）
```

导入方式：
```javascript
import { getCoverUrl } from '@sonic-music/shared/utils/cover'
import { useSettingsStore } from '@sonic-music/shared/stores/settings'
import { THEME_COLORS } from '@sonic-music/shared/constants'
```

---

## API 调用规范

```javascript
// api/client.js 封装了 uni.request，统一通过它调用
import { get, post } from '@/api/client'

// API 模块
export const getRecommend = () => get('/everyday/recommend')
export const getSongUrl = (hash, quality) => get('/song/url', { hash, quality })

// 组件中调用
const response = await getRecommend()
if (response.status === 1) {
  songs.value = response.data.song_list
}
```

---

## Pinia Store 规范

```javascript
// 定义（与 Electron 完全一致）
export const usePlayerStore = defineStore('player', {
  state: () => ({ currentSong: null, playing: false }),
  actions: { setCurrentSong(song) { this.currentSong = song } },
})

// 使用（不用 storeToRefs）
const playerStore = usePlayerStore()
console.log(playerStore.currentSong)
playerStore.setCurrentSong(song)
```

持久化用 `uni.getStorageSync`：
```javascript
persist: {
  strategies: [{
    storage: {
      getItem: (key) => uni.getStorageSync(key),
      setItem: (key, val) => uni.setStorageSync(key, val),
      removeItem: (key) => uni.removeStorageSync(key),
    }
  }]
}
```

---

## 模块开发顺序（依赖关系）

```
packages/shared（工具函数 + stores）
    ↓
apps/mobile/src/api/client.js（HTTP 客户端）
    ↓
apps/mobile/src/api/*.js（各业务 API）
    ↓
apps/mobile/src/stores/（player.js、ui.js）
    ↓
apps/mobile/src/composables/（useAudioPlayer 等）
    ↓
apps/mobile/src/components/（player/ 和 common/）
    ↓
apps/mobile/src/pages/（各页面）
```

### Phase 1 - 基础设施（已完成）
shared 包、mobile 脚手架、api/client.js、各 API 模块

### Phase 2 - 核心播放功能
stores/player.js → useAudioPlayer.js → usePlaybackMode.js → useQueue.js → useLyrics.js → player 组件 → pages/player/index.vue → App.vue 挂载 MiniPlayer

### Phase 3 - 主要页面
公共组件（EmptyState/NavBar/SongListItem/PlaylistCard 等）→ home/search/playlist/library/settings

### Phase 4 - 完善功能
discover/artist/album/ranking/login 页面、download store、CI/CD

---

## 已知问题与解决方案

### Vite 7 与 @dcloudio/uni-h5-vite 兼容问题

**问题**：electron 使用 Vite 7（ESM-only），uni-h5-vite 用 `require('vite')` 解析到 Vite 7 导致 `ERR_REQUIRE_ESM`。

**解决方案**：
1. `package.json` 中添加 `pnpm.packageExtensions` 声明 dcloudio 包的 vite peer dep
2. `.npmrc` 中 `hoist-pattern[]=!vite` 阻止 vite 提升
3. 在 `node_modules/.pnpm/@dcloudio+uni-h5-vite.../node_modules/` 创建指向 Vite 5 的 junction

**注意**：junction 在 `pnpm install` 后会被清除，需重新创建：
```powershell
New-Item -ItemType Junction -Path 'node_modules/.pnpm/@dcloudio+uni-h5-vite@.../node_modules/vite' -Target 'node_modules/.pnpm/vite@5.4.19_terser@5.46.0/node_modules/vite'
```

### index.html 必须在 apps/mobile/ 根目录

vite 的 root 是 `apps/mobile/`，`index.html` 必须放在这里（不是 `src/`），且必须包含：
```html
<script type="module" src="/src/main.js"></script>
```

---

## 布局参考

```
Electron（侧边栏）              Mobile（底部导航）
┌──────────────────────┐       ┌──────────────────┐
│  Sidebar  │  Content │  →    │     Content      │
├───────────┴──────────┤       ├──────────────────┤
│     PlayerControl    │       │   MiniPlayer     │
└──────────────────────┘       ├──────────────────┤
                               │    Tab Bar       │
                               └──────────────────┘
```

MiniPlayer 定位：
```css
.mini-player {
  position: fixed;
  bottom: calc(100rpx + env(safe-area-inset-bottom));
  left: 0; right: 0;
  z-index: 999;
}
```
